<!doctype html><html lang=de><head><title>Docker services via docker-compose und systemd template :: Philipp Weißmann</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Docker ist das derzeit omnipresente Werkzeug um Dienste in Containern auszuführen.
Wie kann man jedoch einen logischen Verbund an Diensten mit dem System zusammen starten?
Mit der Hilfe von Docker können Anforderungen eines Dienstes (z.B. Gitlab) an die Distribution innerhalb eines Containers befriedigt werden. Das ausführende System aussenherum bleibt davon unberührt und kann auch eine inkompatible Distribution sein.
In der Praxis werden jedoch oft mehrere Dienste in einem Verbund benötigt. Diese können mit dem Tool docker-compose beschrieben und gestartet werden."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://philipp-weissmann.de/docker-compose_mit_systemd/><link rel=stylesheet href=https://philipp-weissmann.de/styles.css><link rel="shortcut icon" href=https://philipp-weissmann.de/img/theme-colors/pink.png><link rel=apple-touch-icon href=https://philipp-weissmann.de/img/theme-colors/pink.png><meta name=twitter:card content="summary"><meta property="og:locale" content="de"><meta property="og:type" content="article"><meta property="og:title" content="Docker services via docker-compose und systemd template"><meta property="og:description" content="Docker ist das derzeit omnipresente Werkzeug um Dienste in Containern auszuführen.
Wie kann man jedoch einen logischen Verbund an Diensten mit dem System zusammen starten?
Mit der Hilfe von Docker können Anforderungen eines Dienstes (z.B. Gitlab) an die Distribution innerhalb eines Containers befriedigt werden. Das ausführende System aussenherum bleibt davon unberührt und kann auch eine inkompatible Distribution sein.
In der Praxis werden jedoch oft mehrere Dienste in einem Verbund benötigt. Diese können mit dem Tool docker-compose beschrieben und gestartet werden."><meta property="og:url" content="https://philipp-weissmann.de/docker-compose_mit_systemd/"><meta property="og:site_name" content="Philipp Weißmann"><meta property="og:image" content="https://philipp-weissmann.de/img/container.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="Uncategorized"><meta property="article:published_time" content="2017-12-21 21:05:32 +0000 UTC"></head><body class=pink><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Philipp Weißmann</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/impressum>Impressum</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/impressum>Impressum</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://philipp-weissmann.de/docker-compose_mit_systemd/>Docker services via docker-compose und systemd template</a></h1><div class=post-meta><time class=post-date>2017-12-21 ::
[Updated :: 2017-12-21]</time>
<span class=post-author>Philipp Weißmann</span></div><span class=post-tags>#<a href=https://philipp-weissmann.de/tags/docker/>Docker</a>&nbsp;
#<a href=https://philipp-weissmann.de/tags/linux/>Linux</a>&nbsp;
#<a href=https://philipp-weissmann.de/tags/systemd/>Systemd</a>&nbsp;</span>
<img src=https://philipp-weissmann.de/img/container.jpg class=post-cover alt="Docker services via docker-compose und systemd template" title="Cover Image"><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents></nav></div><div class=post-content><div><p><a href=https://www.docker.com/>Docker</a> ist das derzeit omnipresente Werkzeug um Dienste in Containern auszuführen.</p><p>Wie kann man jedoch einen logischen Verbund an Diensten mit dem System zusammen starten?</p><p>Mit der Hilfe von Docker können Anforderungen eines Dienstes (z.B. <a href=https://gitlab.com>Gitlab</a>) an die Distribution innerhalb eines Containers befriedigt werden. Das ausführende System aussenherum bleibt davon unberührt und kann auch eine inkompatible Distribution sein.</p><p>In der Praxis werden jedoch oft mehrere Dienste in einem Verbund benötigt. Diese können mit dem Tool <a href=https://docs.docker.com/compose/>docker-compose</a> beschrieben und gestartet werden.</p><p>Will man nun Dienste via docker-compose mit dem System zusammen starten, bietet sich folgende Vorgehensweise an:</p><p>Als erstes definieren wir ein Dienst-Template in einer neuen Datei <code>/etc/systemd/system/dc@.service</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>%i service with docker compose</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span><span style=color:#f92672>=</span><span style=color:#e6db74>docker.service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>docker.service</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>always</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>TimeoutStartSec</span><span style=color:#f92672>=</span><span style=color:#e6db74>1200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WorkingDirectory</span><span style=color:#f92672>=</span><span style=color:#e6db74>/opt/dockerfiles/%i</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove old containers, images and volumes and update it</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/docker-compose down -v</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/docker-compose rm -fv</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/docker-compose pull</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compose up</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/docker-compose up</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Compose down, remove containers and volumes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/docker-compose down -v</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>Wir gehen dabei davon aus, dass alle docker-compose Konfigurationsdateien in <code>/opt/dockerfile/DIENSTNAME</code> liegen und sich <code>docker-compose</code> im Verzeichnis <code>/usr/local/bin</code> liegt.</p><p>Nun legen wir unsere docker-compose.yml Datei z.B. in <code>/opt/dockerfile/gitlab/docker-compose.yml</code> ab.</p><p>Nun weisen wir systemd an, das Template zu instanziieren:</p><p><code>sudo systemctl enable dc@gitlab</code></p><p>Ab sofort ist der Dienst vorhanden und kann auch direkt gestartet werden:</p><p><code>sudo systemctl start dc@gitlab</code></p><p>Beim starten des Dienstes wird auch das Image aktualisiert - ist dies nicht gewünscht, muss lediglich die entsprechende Zeile im Template entfernt werden.</p><p>Viel Spaß!</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://philipp-weissmann.de/skripte-schoener-abbrechen/><span class=button__icon>←</span>
<span class=button__text>Skripte schöner abbrechen</span></a></span>
<span class="button next"><a href=https://philipp-weissmann.de/python-auf-dem-esp8266/><span class=button__text>Python auf dem ESP8266</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>